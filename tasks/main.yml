---

- name: update package sources and upgrade system
  apt:
      update_cache: yes
      upgrade: yes

- name: Install required packages
  package:
      name: "{{ item }}"
      state: latest
  with_items: "{{ packages }}"

- name: Partition 2nd drive
  filesystem:
      fstype: ext2
      dev: '{{ dockerdisk }}'
      opts: -L DOCKERDRV

- name: Use 2nd drive as docker storageprovider
  mount:
      src: LABEL=DOCKERDRV
      name: /var/lib/docker
      fstype: ext2
      state: mounted

- name: add docker repokey
  apt_key:
        url: "{{ docker_repo_key_src }}"
        state: present

- name: add docker repo to packages sources
  apt_repository:
        repo: "{{ docker_repo_uri }}"
        state: present

- name: install docker
  apt:
      update_cache: yes
      name: docker-ce
      state: latest

- name: Create docker group
  group:
      name: docker
      state: present

- name: Create user for docker
  user:
      name: runner
      group: docker
      state: present

- name: Start dockerd
  service:
      name: docker
      enabled: yes
      state: restarted

- name: Fetch Container Sources
  git:
      repo: "{{ item.uri }}"
      dest: "{{ item.dest }}"
  with_items: "{{ containers }}"

- name: build containers
  command: cd "{{ item.dest }}" && docker build -t "{{ item.name }}"
  become: yes
  become_user: runner
  with_items: "{{ containers }}"

- name: run database container
  command: docker run --rm -t -i -P -d --name postgres_94 postgres_94
  become: yes
  become_user: runner

- name: run application container
  command: docker run --rm -t -i -p 8080:5000 --name flask_jsonstore --link postgres_94:pg flask_jsonstore
  become: yes
  become_user: runner

- debug: msg="Your application should be available at localhost:8080"
